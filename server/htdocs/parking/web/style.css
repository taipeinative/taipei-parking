:root{
  --bg: #0a0b10;
  --panel: rgba(18,22,33,.6);
  --panel-strong: rgba(18,22,33,.9);
  --glass: rgba(255,255,255,.06);
  --stroke: rgba(255,255,255,.08);
  --txt: #e5f2ff;
  --muted: #8aa0b3;
  --accent: #7afcff;       /* 青色霓虹 */
  --accent-2: #ff6ad5;     /* 粉紫霓虹 */
  --accent-3: #ffe45e;     /* 霓虹黃 */
  --ok: #58ff9c;
  --warn: #ffb86b;
  --err: #ff5d5d;
  --shadow-neon: 0 0 8px rgba(122,252,255,.7), 0 0 18px rgba(122,252,255,.35);
  --radius: 16px;
  --radius-sm: 10px;
  --blur: saturate(140%) blur(8px);
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}

html, body { height: 100%; margin: 0; background: radial-gradient(1200px 700px at 20% 10%, #0f1322 0%, #0a0b10 60%, #07080d 100%); color: var(--txt); font-family: var(--sans); }
#map { height: 100%; width: 100%; filter: saturate(115%); }

/* ====== Global micro-interactions ====== */
* { box-sizing: border-box; }
::selection { background: rgba(122,252,255,.25); color: #e8fbff; }
::-webkit-scrollbar { width: 10px; height: 10px; }
::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #2a3246, #1a1f2d); border: 1px solid #2f3a53; border-radius: 10px; }
::-webkit-scrollbar-track { background: transparent; }

.glass {
  background: var(--panel);
  border: 1px solid var(--stroke);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
  box-shadow: 0 6px 22px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
}

.neon { box-shadow: var(--shadow-neon); }

.chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #223048; background: rgba(20,26,38,.6); color: var(--txt); font-size:12px; }

.kbd { font-family: var(--mono); font-size: 11px; border:1px solid #2a3348; background:#121722; color:#b8ccff; padding:2px 6px; border-radius:6px; }

/* ====== Top Bar ====== */
.topbar {
  position: absolute; left: 14px; right: 14px; top: 12px; z-index: 1000; display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center;
}
.brand { display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius: var(--radius); }
.brand .logo { width: 18px; height: 18px; border-radius: 3px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow-neon); }
.brand h1 { margin:0; font-size: 14px; letter-spacing:.08em; font-weight:700; color:#dff9ff; text-shadow: 0 0 12px rgba(122,252,255,.25); }

.mode-switch {
  display:flex; gap:8px; padding:8px; border-radius: var(--radius); align-items:center;
}
.mode-switch .btn { position: relative; border:1px solid #2b3146; background: linear-gradient(180deg, #131827, #0e1421); color:#cfe9ff; padding:8px 12px; font-size:12px; border-radius: 10px; cursor:pointer; transition:.18s ease; }
.mode-switch .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,.35), inset 0 0 0 1px rgba(122,252,255,.18); }
.mode-switch .btn.active { color:#071016; background: linear-gradient(180deg, #7afcff, #00d6e3); border-color: transparent; text-shadow:none; }

.toggles { display:flex; gap:10px; padding:8px; border-radius: var(--radius); }
.toggles label { display:flex; align-items:center; gap:8px; font-size:12px; padding:6px 10px; border-radius: 999px; border:1px dashed #2b3248; cursor: pointer; background: rgba(10,14,23,.7); }
.toggles input { accent-color: var(--accent); }

/* ====== Time Segments ====== */
.segments { position: absolute; left: 14px; top: 74px; z-index: 1000; display:flex; gap:6px; padding:8px; border-radius: var(--radius); }
.seg { border:1px solid #2a3147; background: #0f1525; color:#cde7ff; padding:6px 10px; border-radius: 999px; cursor:pointer; font-size:12px; transition:.18s; }
.seg:hover { transform: translateY(-1px); }
.seg.active { background:linear-gradient(180deg, #ff6ad5, #be3aa1); color:#fff; border-color:transparent; box-shadow: 0 4px 16px rgba(255,106,213,.35); }

/* ====== Left Dock: Editor ====== */
.dock-left { position: absolute; left: 14px; bottom: 14px; z-index: 1000; display:flex; gap:10px; }
.btn-ghost { border:1px dashed #2b3147; background: rgba(10,14,23,.5); color:#cfe4ff; padding:10px 12px; border-radius: 12px; cursor:pointer; font-size:12px; transition:.2s; }
.btn-ghost:hover { border-style: solid; border-color:#3d4c72; box-shadow: 0 6px 20px rgba(0,0,0,.35), inset 0 0 0 1px rgba(122,252,255,.14); transform: translateY(-1px); }
.btn-ghost.active { color:#071016; background: linear-gradient(180deg, #7afcff, #00d6e3); border-color: transparent; }

/* ====== Right Dock: Weights Panel ====== */
.weights { position: absolute; right: 14px; bottom: 14px; z-index: 1000; width: 520px; max-width: calc(100vw - 28px); border-radius: var(--radius); overflow: hidden; }
.weights-header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer; user-select:none; }
.weights-title { display:flex; align-items:center; gap:10px; }
.chev { width: 10px; height: 10px; border-right: 2px solid #98c9ff; border-bottom: 2px solid #98c9ff; transform: rotate(45deg); transition: transform .2s ease; opacity:.9; }
.weights.collapsed .chev { transform: rotate(-135deg); }

.weights-body { padding: 10px 14px 14px; display:block; }
.weights.collapsed .weights-body { display:none; }

.note { color: var(--muted); font-size:11px; margin-top:6px; }

.supply-row { display:flex; align-items:center; gap:10px; margin: 4px 0 12px 0; }
.supply-row input { width: 160px; padding:8px 10px; border:1px solid #2b3147; border-radius: 12px; background:#0b0f1b; color:#dff0ff; font-size:12px; text-align:center; }

.wtable { display:grid; grid-template-columns: 1.2fr repeat(3, 120px); gap: 8px 10px; align-items:center; }
.wtable .wh { font-weight:700; text-align:center; color:#bfe8ff; }
.wtable .wl { font-weight:600; color:#daecff; }
.wtable input { width:100%; padding:8px 10px; border:1px solid #2b3147; border-radius: 12px; background:#0b0f1b; color:#eaf5ff; font-size:12px; text-align:center; }

.actions { margin-top:12px; display:flex; gap:10px; }
.btn { border:1px solid #2b3147; background:#0f1525; color:#dff2ff; padding:10px 12px; border-radius: 12px; cursor:pointer; font-size:12px; transition:.18s; }
.btn:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,.35); }
.btn.primary { background: linear-gradient(180deg, #ffe45e, #ffba15); color:#1a1400; border-color: transparent; box-shadow: 0 6px 16px rgba(255,186,21,.25); }

/* ====== Legend (glass neon) ====== */
.legend { background: var(--panel-strong); border: 1px solid var(--stroke); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur); padding:10px 12px; line-height:1.35; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04); color:#d4ecff; }
.legend .title { font-weight:800; margin-bottom:6px; letter-spacing:.04em; text-transform: uppercase; font-size:12px; color:#9fdfff; }
.legend i { width:14px; height:14px; display:inline-block; margin-right:8px; border-radius:3px; vertical-align:-2px; box-shadow: 0 0 0 1px rgba(0,0,0,.35), 0 0 8px rgba(255,255,255,.06) inset; }
.legend-left { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); z-index: 1200; }

/* Hover focus for polygons */
.pulse { animation: pulse 1.2s ease-out infinite; }
@keyframes pulse { 0%{ box-shadow: 0 0 0 0 rgba(122,252,255,.4);} 100%{ box-shadow: 0 0 0 12px rgba(122,252,255,0);} }

/* Add-mode: allow clicks to pass through polygons */
#map.adding-lots .leaflet-interactive { pointer-events: none; }

/* Responsive small */
@media (max-width: 880px) {
  .mode-switch { grid-column: 1 / -1; justify-content:center; }
  .segments { top: 120px; }
  .weights { width: 96vw; left: 2vw; right: 2vw; }
  .wtable { grid-template-columns: 1fr repeat(3, 92px); }
}